# Инструкция по библиотеке OpenCV и OpenCL

{черновой вариант, инструкция находится в разработке}

Библитека машинного обучения OpenCV (https://opencv.org/) предназначена для обработки изображений.

## Подготовка к работе

1) Собрать образ 

```
docker-compose -f ./images/docker-compose-build.yaml up --build cpp 
```

2) Запустить образ в виде контейнера

Для запуска образа можно воспользоваться существующим сервисом jupyter (./jupyter/jupyter.yaml). Отредактировать файл: изменить секцию `image:`, указать в ней `cpp:latest`, строка будет выглядеть так `image: cpp:latest`; изменить секцию `command:`, заменить строку `- /home/sdl/.local/bin/jupyter-lab ...` на строку `tail -f /dev/null`.

```
command:
- bash
- -c
#- /home/sdl/.local/bin/jupyter-lab --ip jupyter --no-browser --NotebookApp.token='822fce15430e96de9bc18fedf9f938796db4c7927f912028' --NotebookApp.base_url=jupyter --NotebookApp.default_url=lab
- tail -f /dev/null
```

После этого изменения jupyter не будет запускаться.

## Настройка окружения контейнера

Оригинал инструкции представлен здесь https://code.visualstudio.com/docs/cpp/config-linux

1) Перейти в контейнер VSCode -> Remote Explorer -> Dev Containers -> Attach New Window
2) Установить дополнительное расширение для VSCode 

```bash
code --install-extension ms-vscode.cpptools
code --install-extension ms-vscode.cpptools-extension-pack
````

## Проверка окружения

1) Создать папки для проверочного примера

```
mkdir /home/sdl/helloworld
cd /home/sdl/helloworld
mkdir .vscode
```

2) Открыть рабочую папку File -> Open Folder папка `/home/sdl/helloworld`

3) Создать файлы

Создать файл .vscode/tasks.json в этом файле от значения по умолчанию отличаюются несколько параметров отвечающих за месторасположение библиотек OpenCV.

```
"-I/usr/local/include/opencv4",
"-I/usr/include/opencv4",
"-lopencv_core", "-lopencv_videoio", "-lopencv_highgui", "-lopencv_imgcodecs",
"-lOpenCL",
```

Полный файл

```json
{
    "tasks": [
        {
            "type": "cppbuild",
            "label": "C/C++: g++ build active file",
            "command": "/usr/bin/g++",
            "args": [
                "-fdiagnostics-color=always",
                "-g",
                "${file}",
                "-I/usr/local/include/opencv4",
                "-I/usr/include/opencv4",
                "-I/usr/include",
                "-lopencv_core", "-lopencv_videoio", "-lopencv_highgui", "-lopencv_imgcodecs",
                "-lOpenCL",
                "-o",
                "${fileDirname}/${fileBasenameNoExtension}"
            ],
            "options": {
                "cwd": "${fileDirname}"
            },
            "problemMatcher": [
                "$gcc"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "detail": "Task generated by Debugger."
        }
    ],
    "version": "2.0.0"
}
```

Создать файл .vscode/c_cpp_properties.json в этом файле от значения по умолчанию отличаюются несколько параметров отвечающих за месторасположение библиотек OpenCV.

```
            "includePath": [
                "${workspaceFolder}/**",
                "/usr/local/include/opencv4"
            ],
```

Полный файл

```json
{
    "configurations": [
        {
            "name": "Linux",
            "includePath": [
                "${workspaceFolder}/**",
                "/usr/include/opencv4"
            ],
            "defines": [],
            "compilerPath": "/usr/bin/gcc",
            "cStandard": "c17",
            "cppStandard": "gnu++17",
            "intelliSenseMode": "linux-gcc-x64"
        }
    ],
    "version": 4
}
```

Создать файл helloworld.cpp

```C++
#include <iostream>
#include <vector>
#include <string>

using namespace std;

int main()
{
    vector<string> msg {"Hello", "C++", "World", "from", "VS Code", "and the C++ extension!"};

    for (const string& word : msg)
    {
        cout << word << " ";
    }
    cout << endl;
}
```

4) Запустить файл 'helloworld.cpp' в правом верхнем углу пункт выпадающего меню 'Run C/C++ Run'.

Успешная компиляция выглядит следующим образом.

```bash
...
[Inferior 1 (process 2511) exited normally]
The program '/home/sdl/helloworld/helloworld' has exited with code 0 (0x00000000).
```

## Запуск примера OpenCV

1) Закинуть в контейнер любое изображение с именем 'i1.jpg'. Можно перекинуть манипулятором мышь из проводника в окно VSCode в текущую папку.

2) Настроить Xming (для ОС Windows)

Установить Xming (https://sourceforge.net/projects/xming/). Запустить `C:\Program Files (x86)\Xming\XLaunch.exe`. В пошаговых настройках указать опцию 'No Access Control', сохранить выбранную конфигурацию и в дальнейшем для запуска пользоваться этим файлом.

Посмотреть на каком IP адресе запустился сервер Xming. В ОС Windows рядом с часами выбрать иконку Xming, в контекстном меню выбрать 'View Log'. В журнале найти строку 'XdmcpRegisterConnection: newAddress'. Запомнить IP адрес.

Примечание: Для диагностики Xming можно установить часы `apt-get install -y x11-apps`, запустить `xclock`.

3) Запустить программу.

Создать файл test1.cpp

```
#include<opencv2/opencv.hpp>
#include<opencv2/core/mat.hpp>
#include <opencv2/imgcodecs.hpp>
#include <iostream>
using namespace cv;
int main()

{     
    cv::Mat image1,image2; 
    image1=cv::imread("i1.jpg"); //имя файла изображения
    cv::namedWindow("image1",cv::WINDOW_AUTOSIZE); 
    cv::imshow("image1",image1); // created the window by name image1 
    cv::waitKey(0); 
    cv::destroyWindow("image1");     
    return 0; 
}
```

При первом запуске должна появиться ошибка. Ошибка 'qt.qpa.xcb: could not connect to display ' означает, что не запущен или не корректно настроен Xming.
В этом же окне терминала выплнить команду 'export DISPLAY=<IP адрес Xming>:0.0'. Еще раз запустить программу. Во втором случае должно появиться окно с изображением 'i1.jpg'.

